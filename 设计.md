# 功能要求

**对话：**系统应支持用户之间的一对一和群组对话。
**确认消息：**系统应支持消息传递确认，如已发送、已送达、已读。
**共享：**系统应支持媒体文件的共享，例如图像、视频和音频。
**聊天存储：**系统必须支持用户离线时聊天消息的持久存储，直到消息成功传递。
**推送通知：**一旦离线用户的状态变为在线，系统应该能够向其通知新消息。



# 非功能性需求

**低延迟：**用户应该能够以低延迟接收消息。
**一致性：**消息应该按照发送的顺序传递。此外，用户必须在所有设备上看到相同的聊天历史记录。
**可用性：**系统应该具有高可用性。然而，一致性比可用性更重要。
**安全性：**系统必须通过端到端加密来保证安全。我们需要确保只有通信双方才能看到消息的内容。中间的任何人，甚至我们作为服务所有者，都不应有权访问。
**可扩展性：**系统应该具有高度可扩展性，以支持每天不断增加的用户和消息数量。



# 设计

添加好友：能够通过UID搜索、群聊和临时会话添加好友，添加好友首先发送请求，在添加好友界面能够填写备注。对方能够在好友申请中看到申请，能选择同意或者拒绝。添加好友应该有单独的界面，无论是用户UID搜索、群聊还是临时会话添加好友，逻辑应该要统一。

删除好友：在聊天界面或者好友主页能点击删除好友，删除好友后与其两人的聊天记录会保留，其在好友列表中会消失。但对方的好友列表中还能看到你，只有点进去后才能看到提示。

临时会话：在未添加好友的情况下，可以发起临时会话。临时会话在对方回复前最多只能发送一条，即：A主动与B发起临时会话，A最多只能发送一条消息，在B回复之前不能继续发送，继续发送会弹出提示，在B看到消息并回复后，A与B能继续通过临时会话聊天。临时会话的聊天界面顶部有“你们还不是好友”的提示，并显示添加好友的按钮。在正式添加好友后，原有的临时会话聊天记录会被保留。

群聊：群聊最少人数为3个，群主支持编辑群聊信息。包含邀请群成员、移除群成员、解散群聊、修改群备注等功能。群聊支持艾特@群成员。在群聊中，未与其添加好友的群成员只能看到他的昵称、UID、点赞和个性签名信息，其他的无法看到，包含在线状态等。
好友分组：在通讯录界面显示好友分组，可以自由添加、删除、编辑分组，在好友界面可以选择其在哪个分组，但是至少要有一个默认分组。

好友备注：可为空，最长为32位，显示在聊天记录和分组中。默认是为空，若为空则显示对方自己的昵称。

好友线索：最长128位，用于用户记录与其相关的内容。

点赞：只能给别人点赞，不能给自己点赞。给别人点赞，单个用户一天只能点赞一个。

聊天记录：保存在本地，支持导出。先同步后存储，对于在线的用户，消息会直接实时同步到在线的接收方，消息同步成功后，并不会进行持久化。而对于离线的用户或者消息无法实时同步成功时，消息会持久化到离线库，当接收方重新连接后，会从离线库拉取所有未读消息。当离线库中的消息成功同步到接收方后，消息会从离线库中删除。传统的消息系统，服务端的主要工作是维护发送方和接收方的连接状态，并提供在线消息同步和离线消息缓存的能力，保证消息一定能够从发送方传递到接收方。服务端不会对消息进行持久化。

聊天记录漫游：暂时取消计划，若已经设计则删除相关的功能。
消息界面：若有未读信息，界面显示气泡。气泡显示未读信息数，在点进聊天界面已读时消失。单个聊天右键选择删除，置顶，如果有未读消息则还显示忽略未读的按钮。
聊天界面：显示聊天对话消息时间，表情包，表情包可以使用emoji库（例如github.com/kyokomi/emoji）。聊天记录支持富文本，但是不能对服务器造成损害。消息支持三分钟内撤回。
通讯录：显示所有好友和群聊，以及好友分组。点击好友可以查看好友主页。临时会话不算好友。若好友删除了你但你没有删除对方的话要算进去，但是在聊天界面要显示非好友提示。

好友主页：主页显示的元素有：昵称、好友备注、好友线索、UID、点赞数（支持点赞）、在线状态。发消息、删除好友

个人主页：显示个人昵称、UID、在线状态、点赞数（只显示数量，不能给自己点赞）等。显示编辑昵称、编辑个性签名、修改密码、注销登录等。

# 技术层面

聊天服务器便于发送/接收消息。
状态服务器管理在线/离线状态。
API服务器处理一切，包括用户登录、注册、更改配置文件等。
通知服务器发送推送通知。
键值存储用于存储聊天历史记录。当离线用户联机时，用户将看到以前的所有聊天记录。

### 消息ID：

消息id负责确保消息的顺序。要确定消息的顺序，消息id必须满足以下两个要求：
ID必须是唯一的。
ID应按时间进行排序，这意味着新行的ID高于旧行。

未完待续......